<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Obrigado pela Compra!</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: #fff0f3;
      text-align: center;
      color: #333;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 2rem;
    }
    .circle-img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid #ff758f;
      margin: 0 auto 1rem auto;
      display: block;
      object-fit: cover;
    }
    h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
    p { font-size: 1rem; margin-bottom: 1.5rem; }
    .btn {
      background: #229ED9;
      color: #fff;
      padding: 0.8rem 1.6rem;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
      display: inline-block;
      margin-top: 1rem;
      transition: 0.2s ease;
    }
    .btn:hover { filter: brightness(1.1); }
  </style>

  <!-- TikTok Pixel Code Start (Client-Side) - NOVO PIXEL -->
  <script>
    !function (w, d, t) {
      w.TiktokAnalyticsObject=t;
      var ttq=w[t]=w[t]||[];
      ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"];
      ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};
      for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);
      ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e};
      ttq.load=function(e,n){
        var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;
        ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};
        var n=document.createElement("script");
        n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;
        var e=document.getElementsByTagName("script")[0];
        e.parentNode.insertBefore(n,e)
      };
      ttq.load('D478L63C77U1BLONNB2G');
      ttq.page();
    }(window, document, 'ttq');
  </script>
  <!-- TikTok Pixel Code End -->
</head>
<body>
  <div class="container">
    <img src="foto.png" alt="Tutorial de acesso" class="circle-img" />
    <h1>Obrigado pela sua compra!</h1>
    <p>Sua compra foi confirmada. Clique abaixo para entrar no grupo VIP exclusivo:</p>
    <a id="telegram-btn" href="https://t.me/+I-pcyWQm0khmYzYx" class="btn">Entrar no Grupo VIP</a>
  </div>

  <!-- TikTok Events API (Server-Side) + Purchase Event -->
  <script>
    const TIKTOK_PIXEL_ID = 'D478L63C77U1BLONNB2G';
    const TIKTOK_ACCESS_TOKEN = 'e84e20422383ee7292b2f1617eb56073ff1662e9';
    const API_ENDPOINT = 'https://business-api.tiktok.com/open_api/v1.3/event/track/';

    // Função para enviar evento Server-Side
    async function sendTikTokServerEvent(eventName, properties = {}) {
      const payload = {
        pixel_code: TIKTOK_PIXEL_ID,
        event: eventName,
        timestamp: new Date().toISOString(),
        event_id: `${eventName}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        context: {
          user_agent: navigator.userAgent,
          ip: '',
          user: {
            external_id: '',
            phone_number: '',
            email: ''
          },
          page: {
            url: window.location.href,
            referrer: document.referrer
          }
        },
        properties: {
          content_type: 'product',
          content_id: 'produto_vip',
          content_name: 'Acesso VIP - Vazadinhos das Famosas',
          currency: 'BRL',
          value: 18.00,
          ...properties
        }
      };

      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Access-Token': TIKTOK_ACCESS_TOKEN,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        if (response.ok) {
          console.log(`[TikTok Server] ${eventName} enviado com sucesso.`);
        } else {
          console.error(`[TikTok Server] Erro ${eventName}:`, await response.text());
        }
      } catch (err) {
        console.error('[TikTok Server] Falha na requisição:', err);
      }
    }

    // Dispara eventos apenas UMA VEZ por navegador
    (function fireEventsOnce() {
      const PURCHASE_KEY = 'tiktok_purchase_fired_v3';
      if (localStorage.getItem(PURCHASE_KEY)) {
        console.log('Eventos já disparados anteriormente.');
        return;
      }

      function triggerEvents() {
        // 1. ViewContent
        sendTikTokServerEvent('ViewContent');

        // 2. Purchase (Server-Side + Client-Side)
        sendTikTokServerEvent('Purchase', {
          value: 18.00,
          currency: 'BRL'
        });

        // Client-side (backup)
        if (typeof ttq === 'object' && typeof ttq.track === 'function') {
          ttq.track('CompletePayment', {
            value: 18.00,
            currency: 'BRL',
            contents: [{
              content_id: 'produto_vip',
              content_type: 'product',
              content_name: 'Acesso VIP - Vazadinhos das Famosas'
            }]
          });
        }

        localStorage.setItem(PURCHASE_KEY, 'true');
        console.log('Todos os eventos de compra disparados (Server + Client).');
      }

      // Aguarda pixel carregar
      window.addEventListener('load', () => {
        setTimeout(triggerEvents, 600);
      });
    })();

    // 3. CompleteRegistration ao clicar no botão
    document.getElementById('telegram-btn').addEventListener('click', () => {
      sendTikTokServerEvent('CompleteRegistration', {
        content_name: 'Entrada no Grupo VIP',
        value: 18.00
      });

      if (typeof ttq === 'object') {
        ttq.track('CompleteRegistration');
      }
    });
  </script>
</body>
</html>
